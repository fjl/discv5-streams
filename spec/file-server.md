# File Server

This specification defines a uTP-based file server protocol that uses discv5 for
connection establishment. File transfer connections are encrypted and authenticated, and
can be multiplexed on the same listening socket as discv5 using the [sub-protocol
connection extension](./discv5-subprotocol.md).

## Client/Server Protocol

Requesting a file transfer is a multi-step process. The client (`A`) first signals its
intent to download a specific file in a TALKREQ message. The server (`B`) confirms or
denies the initial request using TALKRESP.

    A -> B  TALKREQ  "xfer-init" <file-name>
    A <- B  TALKRESP ok <xfer-id>

Note that the session hasn't started yet. The server now locates the file and sends a
'start' request back. This step exists because discv5 has a very short response timeout
(~500ms), but the server might take a bit longer to actually start the transfer (e.g. on a
slow file system, or when rate-limiting is applied). During this round of
TALKREQ/TALKRESP, session secrets are exchanged.

    A <- B  TALKREQ  "xfer-start" <xfer-id> <initiator-secret> <file-size>
    A -> B  TALKRESP ok <recipient-secret>

The server's earlier TALKRESP message and the subsequent TALKREQ might arrive out of
order. The client must wait for both messages to arrive before sending its TALKRESP.

A sub-protocol session is now established on both sides, and uTP can run. Since the file
name and size have already been communicated in earlier requests, the server starts
sending the file content as-is using uTP.

    A <- B  uTP in sub-protocol session
    A <- B  uTP in sub-protocol session
    A -> A  uTP in sub-protocol session
    ...

The transfer ends when the entire file has been sent.

## TALK Messages

The listed message names are used as the `protocol-name` in TALKREQ.

To simplify the implementation, message payloads are RLP-encoded. The notation `[ x, y, z ]`
shows an RLP list with elements `x`, `y`, `z`. Named values are assumed to be RLP byte
arrays unless explicity defined otherwise.

### xfer-init

|          | Payload           |
|----------|-------------------|
| Request  | `[ file-name ]`   |
| Response | `[ ok, xfer-id ]` |

This is the initial request from client to server, requesting the transfer of a file. The
`ok` field can be zero or one. If `ok` is zero, the server denied the request and the
remaining fields are omitted.

`xfer-id` is a 16-bit integer generated by the server. The purpose of this field is
allowing concurrent negotiation of multiple transfers.

### xfer-start

|          | Payload                                    |
|----------|--------------------------------------------|
| Request  | `[ xfer-id, initiator-secret, file-size ]` |
| Response | `[ ok, recipient-secret ]`                 |

This request is sent by the server to start a transfer. `xfer-id` links this request to
the xfer-init request sent by the client. The `initiator-secret` and `recipient-secret`
(16 bytes each) are used for key agreement.

If `ok` is zero in the response, the client has lost interest in this transfer, and the
remaining response fields are omitted.
